<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Simulazione Singola</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/fontawesome-all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/ionicons.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/css/Login-Form-Basic-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/VentasPro-Login.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script> <!-- utile per la gestione della data per i file kml -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.6.0/tinycolor.min.js"></script> <!-- libreria utile per la generazione di un colore randomico in esadecimale -->

    
    <style>

    .bottone {
        width: 100px;
        height: 40px;
        margin: 5px; 
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px; 
        font-size: 13px;
        cursor: pointer;
        align-items: center;
    }

    .bottone:hover {
        background-color: #ffcc00; 
    }
 
    .bottone:active {
        background-color: #ffea00; 
    }

    .disattivato {
        opacity: 0.5; 
        cursor: not-allowed; 
    }

    .slidecontainer {
    width: 100%;
    }

    .slider {
    -webkit-appearance: none;
    width: 100%;
    height: 15px;
    border-radius: 5px;
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
    }

    .slider:hover {
    opacity: 1;
    }

    .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #04AA6D;
    cursor: pointer;
    }

    .slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #04AA6D;
    cursor: pointer;
    }

    </style>
</head>

<body id="page-top" onload="controlKmlOnLoad()">
    <div id="wrapper">
        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0">
            <div class="container-fluid d-flex flex-column p-0">
                <a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#"><img style="width: 32px;height: 33px;" src="{{ url_for('static', filename='/img/Regione_Campania-logo-0A3FAC65C4-seeklogo.com.png') }}">
                    <div class="sidebar-brand-icon rotate-n-15"></div>
                    <div class="sidebar-brand-text mx-3"><span>FUMI2</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item"><a class="nav-link" href="dashboard"><i class="fas fa-terminal"></i><span style="color: var(--bs-accordion-bg);">Dashboard</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="simulazione-singola"><i class="fas fa-eye"></i><span style="color: var(--bs-accordion-bg);">Simulazione singola</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="simulazioni-multiple"><i class="fas fa-list"></i><span style="color: var(--bs-accordion-bg);">Simulazioni multiple</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="storico"><i class="fas fa-table"></i><span style="color: var(--bs-accordion-bg);">Storico</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="profilo">
                        <i class="far fa-user-circle"></i>
                        <span style="color: var(--bs-accordion-bg);">Profilo</span></a>
                    </li>
                    <li class="nav-item"></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">

            <div id="content">

                <nav class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
                    <div class="container-fluid">
                        <button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop" type="button">
                            <i class="fas fa-bars"></i>
                        </button>
                        <small class="form-text fs-4 fw-semibold" style="width: 2348.234px;">Benvenuto! La tua&nbsp;ultima visita risale al: {{ last_access }}&nbsp;</small>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <div class="d-none d-sm-block topbar-divider"></div>
                        </ul>
                        <small class="form-text" style="margin-left: 0px;width: 450.1641px; font-weight:bold">
                            <h2><b>{{ user }}</b></h2>
                        </small>
                        <a href="{{ url_for('logout') }}" class="btn btn-primary" style="white-space: nowrap; text-align: center;">Log Out</a>
                    </div>
                </nav>

                <div class="container-fluid" style="width: auto;height: auto;">

                    <form method="POST" id="form_sim" novalidate>

                        <div class="d-sm-flex justify-content-between align-items-center mb-4" style="border-style: none;">
                            <h3 class="text-dark mb-0">Nuova Simulazione</h3>
                        </div>

                        <div class="row">
                            <div class="col">
                                <div class="row">
                                    <div class="col" style="margin-bottom: 20px;">
                                        <div class="card shadow border-start-primary py-2" style="margin-bottom: 10px;width: auto;height: auto;">
                                            <div class="card-body">
                                                <div class="row align-items-center no-gutters">
                                                    <div class="col me-2">
                                                        <div class="text-uppercase text-primary fw-bold text-xs mb-1"><span>DESCRIZIONE</span></div><input type="text" name="area" id="area_dash" style="width: 162px;" value="test" required>
                                                        <div class="text-dark fw-bold h5 mb-0"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card shadow border-start-primary py-2">
                                            <div class="card-body">
                                                <div class="row align-items-center no-gutters">
                                                    <div class="col me-2">
                                                        <div class="text-uppercase text-primary fw-bold text-xs mb-1"><span style="color: var(--bs-purple);">Longitudine</span></div>
                                                        <div class="text-dark fw-bold h5 mb-0"><span><input type="number" name="long" step="any" id="long_dash" style="width: 160px;" value="54.4"></span></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                            <div class="col">
                                <div class="card shadow border-start-success py-2" style="margin-bottom: 10px;height: 100.8047px;">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-success fw-bold text-xs mb-1"><span>DATA</span></div>
                                                <div class="text-dark fw-bold h5 mb-0"><span><input id="date_dash" type="date" name="data" style="width: 168px;" required></span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card shadow border-start-success py-2">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-success fw-bold text-xs mb-1"><span style="color: var(--bs-indigo);">latitudine</span></div><input type="number" step="any" name="lat" id="lat_dash" style="width: 160px;" value="34.4" required>
                                                <div class="text-dark fw-bold h5 mb-0"><span></span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="col">
                                <div class="card shadow border-start-info py-2" style="margin-bottom: 10px;height: 100.805px;">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-warning fw-bold text-xs mb-1"><span style="color: var(--bs-red);">ora</span></div>
                                                <div class="text-dark fw-bold h5 mb-0">

                                                    <select name="hours" class="Input">
                                                        {% for hour in hours %}
                                                        <option value="{{ hour }}">{{ hour }}</option>
                                                        {% endfor %}
                                                    </select><br><br>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card shadow border-start-info py-2">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-info fw-bold text-xs mb-1"><span style="color: var(--bs-code-color);">Temperatura</span></div><input type="number" name="temp" id="temp_dash" style="width: 160px;" value="200" required>
                                                <div class="row g-0 align-items-center">
                                                    <div class="col-auto">
                                                        <div class="text-dark fw-bold h5 mb-0 me-3"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="col">
                                <div class="card shadow border-start-warning py-2" style="margin-bottom: 10px; height: 100.805px;">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-warning fw-bold text-xs mb-1"><span>DURATA</span></div><input type="number" min="1" name="durata" id="duration_dash" style="width: 160px;" value="1" required>
                                                <div class="text-dark fw-bold h5 mb-0"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card shadow border-start-info py-2">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-info fw-bold text-xs mb-1"><span style="color: var(--bs-code-color);">Codice GISA</span></div><input type="text" name="codice_gisa" id="codice_gisa" style="width: 160px;" value="Codice_Na23">
                                                <div class="row g-0 align-items-center">
                                                    <div class="col-auto">
                                                        <div class="text-dark fw-bold h5 mb-0 me-3"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col">
                                <div class="card shadow border-start-warning py-2" style="margin-bottom: 10px; height: 100.805px;">
                                    <div class="card-body">
                                        <div class="row align-items-center no-gutters">
                                            <div class="col me-2">
                                                <div class="text-uppercase text-success fw-bold text-xs mb-1">
                                                    <span style="color: var(--bs-indigo);">COMUNE</span>
                                                </div>
                                                <input type="text" name="comune" id="comune_label" style="width: 160px;" list="comuni_list" required>
                                                <datalist id="comuni_list">
                                                </datalist>
                                                <div class="text-dark fw-bold h5 mb-0"><span></span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> 


                        <div class="row" style="margin-bottom: 25px;">
                            <div class="col" style="width: auto;margin-left: auto;margin-right: auto;text-align: center;">
                                <button class="btn btn-danger btn-lg" type="submit" name="dresetmap" id="restart-button" style="margin-left: 5px;font-weight: bold;width: auto;height: auto;margin-right: 8px;">&nbsp;Reset&nbsp; <i class="fas fa-eraser"></i> &nbsp; &nbsp;</button>
                                <button class="btn btn-success btn-lg" type="submit" name="generate" id="start-button" style="margin-left: 8px; font-weight: bold;width: auto;height: auto;">&nbsp;Genera&nbsp;<i class="fas fa-globe-americas"></i>&nbsp;</button>
                            </div>
                        </div>
                    </form>

                    <div class="row">
                        <div class="col-lg-12 col-xl-12">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">Mappa Interattiva</h6>
                                </div>
                                <div class="card-body"> 
                                    <div id="map" style="height: 500px; margin: 0;"></div>
                                </div>
                            </div>
                        </div>


                        <div class="col-lg-12 col-xl-12" style="color: var(--bs-card-bg);background: var(--bs-card-cap-bg);" id="options_map">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">Gestione simulazione e visualizzazione</h6>
                                </div>
                                
                                <div class="card-body" style="height: 50%; margin-bottom: 0px;">
                                    <input type="range" min="0" max="120" value="0" step="5" class="slider" id="myRange" list="list_values">
                                    <p>Ora : <span id="demo"></span></p>
                                    <p>Data : 
                                        <select id="days_list">
                                        </select>
                                    </p>
                                </div>

                                <div class="card-body" style="height: 50%; margin-bottom: 0px;">
                                    <button class="btn btn-primary btn-sm" id="bottoneSovrapposizione" style="width: 158.023px;height: 38px;font-weight: bold;background: var(--bs-teal);border-style: none;" onclick="sovraCheck()">Sovrapposizione</button>
                                    <button class="btn btn-primary btn-sm" id="buffer500mt" style="width: 158.023px;height: 38px;font-weight: bold;background: var(--bs-teal);border-style: none;" onclick="bufferCheck500mt">Buffer 500MT</button>
                                    <button class="btn btn-primary btn-sm" id="buffer3km" style="width: 158.023px;height: 38px;font-weight: bold;background: var(--bs-teal);border-style: none;" onclick="bufferCheck3km">Buffer 3KM</button>
                                </div>
                            </div>
                        </div> 
            
                        <div class="col-lg-12 col-xl-12" style="color: var(--bs-card-bg);background: var(--bs-card-cap-bg);" id="options_simulation">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">Info Job</h6>
                                </div>
                                <div class="card-body" style="height: 100%; margin-bottom: 0px;">
                                    <div class="table-responsive">
                                        <table class="table", id="state-table">
                                            <thead>
                                                <tr>
                                                    <th>Identificativo</th>
                                                    <th>calmet</th>
                                                    <th>calpost</th>
                                                    <th>calpufff</th>
                                                    <th>calwrff</th>
                                                    <th>ctgproc</th>
                                                    <th>dst</th>
                                                    <th>lnd2</th>
                                                    <th>makegeo</th>
                                                    <th>terrel</th>
                                                    <th>wrf2calwrf</th>
                                                    <th>www</th>
                                                    <!-- <th>Azioni</th> -->
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!--
                                                <tr> 
                                                    <td>
                                                        <form method="POST">
                                                                <button class="btn btn-danger" id="icancelbtn" type="submit" name="icancel" style="margin-left: 2px;font-weight: bold;" disabled><i class="fas fa-trash"></i></button> 
                                                        </form>
                                                    </td>
                                                </tr>
                                                -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-12 col-xl-12" style="color: var(--bs-card-bg);background: var(--bs-card-cap-bg);" id="options_simulation">
                            <div class="card shadow mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="text-primary fw-bold m-0">Info Simulazione Sottomessa</h6>
                                </div>
                                <div class="card-body" style="height: 100%; margin-bottom: 0px;">
                                    <div class="table-responsive">
                                        <table class="table", id="info-table">
                                            <thead>
                                                <tr>
                                                    <th>Area</th>
                                                    <th>Data</th>
                                                    <th>Ora</th>
                                                    <th>Durata</th>
                                                    <th>Lon</th>
                                                    <th>Lat</th>
                                                    <th>Temp</th>
                                                    <th>Codice GISA</th>
                                                    <th>Comune</th>
                                                </tr>
                                            </thead>
                                            <tbody>

                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>  
                    </div>
                </div>

            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright © Uniparthenope 2023</span></div>
                </div>
            </footer>

        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>

    <script src="{{ url_for('static', filename='bootstrap/js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/source/TileWMS.js"></script>
    <script>

        var slider = document.getElementById("myRange");
        var output = document.getElementById("demo");
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        // url: 'https://tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey=41243fd1949946cf82ab777c68b39278' --- thunderforest site
                        // https://cloud.maptiler.com/maps/
                        url: 'https://api.maptiler.com/tiles/satellite/{z}/{x}/{y}.jpg?key=yNolbzVOYm8BH5d911a9' 
                    }),
                }),
            ],
            view: new ol.View({
                center: [0, 0],
                // center: [lat_client, lon_client],
                zoom: 0,
            })
        });
        var sizeFlagsKML;
        var data;
        var attivo=true;
        var attivoBuffer3km = true;
        var flag_buffer3km = false;
        var attivoBuffer500mt = true;
        var flag_buffer500mt = false;
        var flag_sovrapposizione = false;
        var i=0;
        var lon_client;
        var lat_client;
        const comuniList = document.getElementById('comuni_list');
        var comuni = []

        document.getElementById('comune_label').addEventListener('click', populateDatalist);
        document.getElementById('myRange').addEventListener("input", changeInput);
        window.addEventListener('load', checkID)
        window.addEventListener('load', checkInfoTable)
        document.getElementById('restart-button').addEventListener('click', clearTableInfoSim)

        setInterval(checkProgressWorkflow, 7000);
        
        function changeInput() {
            console.log("cambio input slider");

            // prendo la data dal <select>
            let selected_choice = document.getElementById('days_list');
            let value_selected_choice = selected_choice.options[selected_choice.selectedIndex].value;
            let value_without_char = value_selected_choice.replace(/-/g, "");
            // console.log("[*] data : ", value_without_char);

            // prendo l'ora dall'input slider 
            let selected_hour = slider.value / 5;
            let selected_hour_str = selected_hour.toString();
            if( selected_hour < 10 ) {
                selected_hour_str = selected_hour_str.padStart(2, '0')
            }
            // console.log("[*] ora : ", selected_hour_str);

            // pulisce la mappa dai precedenti .kml
            if(flag_sovrapposizione==false){
                var layers = map.getLayers().getArray();
                layers.forEach(function(layer) {
                if (layer instanceof ol.layer.Vector) {
                        layer.getSource().clear();
                    }
                });
            }

            // crea lo stile ( cambio colore ) per le linee del .kml
            function changeKMLColor(feature, color) {
                feature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: color,
                        width: 1
                    })
                }));
            }

            // creo dinamicamente il path del file kml in base ai parametri impostati dall'utente
            // let url_var =  '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + value_without_char + 'Z' + selected_hour_str + '.kml';
            let url_var = '/static/KML/out_job/' + value_without_char + 'Z' + selected_hour_str + '.kml';

            // carica il file kml in un vector-layer
            let targetVectorLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    url: url_var,
                    format: new ol.format.KML(),
                })
            });

            // cambia effettivamente colore alle vector features nel kml
            targetVectorLayer.getSource().once('change', function(event) {
                if (targetVectorLayer.getSource().getState() === 'ready') {
                        var features = targetVectorLayer.getSource().getFeatures();
                        color = tinycolor.random().toHexString();
                        features.forEach(function(feature) {
                            changeKMLColor(feature, color);
                        });
                    }
                });

            
            // Controllo del buffer da 500m
            if( flag_buffer500mt == true) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 500;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                let vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("flag_buffer section completed")
            }
            
            // Controllo del buffer da 3km
            if( flag_buffer3km == true ) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 3000;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'black',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                let vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("BUFFER [3km] : Added to map")
            }

            map.addLayer(targetVectorLayer); 
        }

        function controlKmlOnLoad(){
            if("{{session['user_dir_name']}}"==""){
                console.log("[CHECK] session[kmlpath_dash] : empty");

                if("{{session['durata']}}"==""){
                    console.log("[CHECK] session[durata] : empty");
                }

            } else {
                var oraInizio = "{{ session['ora_inizio']}}";
                sizeFlagsKML = parseInt("{{ session['durata'] }}")
                data = "{{ session['data'] }}";
            
                var targetVectorLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        // url: '/static/KML/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}")).toString().padStart(2, '0') + ".kml",
                        url: '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + 'Z' + (parseInt("{{ session['ora_inizio'] }}")).toString().padStart(2, '0') + '.kml',
                        format: new ol.format.KML()
                    })
                });

                map.getView().setCenter(ol.proj.fromLonLat([parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")]));
                map.getView().setZoom(13);
                map.addLayer(targetVectorLayer);

                document.getElementById('options_simulation').style.visibility = 'visible';
                document.getElementById('options_map').style.visibility = 'visible';
                /* 
                document.getElementById('div_slider').style.visibility = 'visible';
                document.getElementById('bottoneSovrapposizione').style.visibility = 'visible';
                document.getElementById('buffer3km').style.visibility = 'visible';
                document.getElementById('buffer500mt').style.visibility = 'visible';
                document.getElementById('div_slider').style.visibility = 'visible';
                */ 

                let data_standard = moment(data);
                let data_formatted = data_standard.format('YYYY-MM-DD');
                let int_durata = parseInt("{{session['durata']}}");

                let object_option = document.createElement('option');
                object_option.value = data_formatted;
                object_option.text = data_formatted;
                document.getElementById("days_list").appendChild(object_option);

                if( int_durata > 24) {
                    let tot_giorni = int_durata / 24;
                    for(let k=1; k<=tot_giorni; k++) {
                        var_object = document.createElement('option');
                        let next_day = (data_standard.add(1, 'day')).format('YYYY-MM-DD');
                        var_object.value = next_day;
                        var_object.text = next_day;
                        document.getElementById('days_list').appendChild(var_object);             
                    }
                }
            }
        }

        function nextKML(){

            if( i > parseInt("{{session['durata']}}")) {
                console.log("Max ora durata simulazione");
                return;
            }

            if( ((i+1)%24) == 0 && i!=0) {
                let data_var = moment(data);
                let new_data = data_var.add(1, 'day');
                let format_data = new_data.format('YYYY-MM-DD');
                data = format_data.replace(/-/g, "");
                // normalizzazione dell'indice ( che rappresenta l'ora )
                i = i - 23;
                document.getElementById("data_data").innerText = format_data.toString();
            }

            i+=1;

            if(flag_sovrapposizione==false){
            
                // pulisce il layers kml precedente
                var layers = map.getLayers().getArray();
                layers.forEach(function(layer) {
                if (layer instanceof ol.layer.Vector) {
                        layer.getSource().clear();
                    }
                });
            }

            // crea lo stile ( cambio colore ) per le linee del .kml
            function changeKMLColor(feature, color) {
                feature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: color,
                        width: 1
                    })
                }));
            }
            
            // carica il file kml in un vector-layer
            var targetVectorLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    url : '/static/KML/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml",
                    // url : '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml",
                    format: new ol.format.KML(),
                })
            });

            // cambia effettivamente colore alle vector features nel kml
            targetVectorLayer.getSource().once('change', function(event) {
                if (targetVectorLayer.getSource().getState() === 'ready') {
                        var features = targetVectorLayer.getSource().getFeatures();
                        color = tinycolor.random().toHexString();
                        features.forEach(function(feature) {
                            changeKMLColor(feature, color);
                        });
                    }
                });

            
            // Controllo del buffer da 500m
            if( flag_buffer500mt == true) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 500;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("flag_buffer section completed")
            }
            
            // Controllo del buffer da 3km
            if( flag_buffer3km == true ) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 3000;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("BUFFER [3km] : Added to map")
            }

            map.addLayer(targetVectorLayer);  
            document.getElementById("data_ora").innerText = i.toString();
            console.log("Ora successiva - load kml path : ", '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml");
        }

        function previousKML(){

            if( ((i-1)%24) == 0 && i!=0) { 
                let data_var = moment(data);
                let new_data = data_var.subtract(1, 'day');
                let format_data = new_data.format('YYYY-MM-DD');
                data = format_data.replace(/-/g, "");
                i = i + 23;

                document.getElementById("data_data").innerText = format_data.toString();
            }

            i-=1;


            if(flag_sovrapposizione==false) {
                var layers = map.getLayers().getArray();
                layers.forEach(function(layer) {
                    if (layer instanceof ol.layer.Vector) {
                        layer.getSource().clear();
                    }
                });
            }

            function changeKMLColor(feature, color) {
                feature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: color,
                        width: 1
                    })
                }));
            }
       
            var targetVectorLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    url: '/static/KML/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + (i-1) ).toString().padStart(2, '0') + ".kml",
                    // url: '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml",
                    format: new ol.format.KML(),
                })
            });

            targetVectorLayer.getSource().once('change', function(event) {
                if (targetVectorLayer.getSource().getState() === 'ready') {
                        var features = targetVectorLayer.getSource().getFeatures();
                        color = tinycolor.random().toHexString();
                        features.forEach(function(feature) {
                            changeKMLColor(feature, color);
                        });
                    }
                });
            
            
            // Controllo del buffer da 500m
            if( flag_buffer500mt == true) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 500;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("flag_buffer section completed")
            }
            
            // Controllo del buffer da 3km
            if( flag_buffer3km == true ) {
                let center = [parseFloat("{{session['lon']}}"), parseFloat("{{session['lat']}}")];
                let radius = 3000;
                let circle = new ol.geom.Circle(ol.proj.fromLonLat(center), radius);
                let circleFeature = new ol.Feature(circle);
                let circleStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'red',
                        width: 1
                    }),
                });

                circleFeature.setStyle(circleStyle);

                // Crea un'istanza di ol.source.Vector per contenere la circonferenza
                let vectorSource = new ol.source.Vector({
                    features: [circleFeature]
                    });

                // Crea un'istanza di ol.layer.Vector per visualizzare la circonferenza sulla mappa
                var vectorLayer = new ol.layer.Vector({
                    source: vectorSource
                    });

                map.addLayer(vectorLayer);
                console.log("BUFFER [3km] : Added to map")
            }
          
            // Aggiunta kml della simulazione alla mappa
            map.addLayer(targetVectorLayer);
            document.getElementById("data_ora").innerText = i.toString();
            console.log("Ora successiva - load kml path : ", '/static/KML/' + "{{session['user_dir_name']}}" + '-out/out_job/' + data + "Z" + (parseInt("{{ session['ora_inizio'] }}") + i ).toString().padStart(2, '0') + ".kml");

        }

        function sovraCheck() {
            attivo = !attivo;
            var bottone = document.getElementById("bottoneSovrapposizione");
            if (attivo) {
                bottone.classList.remove("disattivato");
                console.log("SOVRAPPOSIZIONE : disattivato");
                flag_sovrapposizione = false;
            } else {
                bottone.classList.add("disattivato");
                console.log("SOVRAPPOSIZIONE : attivato");
                flag_sovrapposizione = true;
            }
        }

        function bufferCheck3km() {
            attivoBuffer3km = !attivoBuffer3km;
            var bottone = document.getElementById("buffer3km");
            if (attivoBuffer3km) {
                bottone.classList.remove("disattivato");
                console.log("BUFFER [3km] : disattivato");
                flag_buffer3km = false;
            } else {
                bottone.classList.add("disattivato");
                console.log("BUFFER [3km] : attivato");
                flag_buffer3km = true;
            }
        }

        function bufferCheck500mt() {
            attivoBuffer500mt = !attivoBuffer500mt;
            var bottone = document.getElementById("buffer500mt");
            if (attivoBuffer500mt) {
                bottone.classList.remove("disattivato");
                console.log("BUFFER [500mt] : disattivato");
                flag_buffer500mt = false;
            } else {
                bottone.classList.add("disattivato");
                console.log("BUFFER [500mt]: attivato");
                flag_buffer500mt = true;
            }
        }

        function populateDatalist() {
            comuniList.innerHTML = '';  // Pulisce eventuali opzioni esistenti
            comuni.forEach(comune => {
                const option = document.createElement('option');
                option.value = comune;
                comuniList.appendChild(option);
            });
        }
        
        function checkID() {
            if("{{session['workflow_id']}}" != "") {
                console.log("[*] workflow id  : ", "{{session['workflow_id']}}");
                let table = document.getElementById('state-table').getElementsByTagName('tbody')[0];
                let newRow = table.insertRow();
                let idJobCell = newRow.insertCell(0)
                idJobCell.textContent = "{{session['workflow_id']}}";
            }
        }
        
        function checkInfoTable(){
            if("{{session['area']}}" != "") {
                let table = document.getElementById('info-table').getElementsByTagName('tbody')[0];
                let newRow = table.insertRow();

                newRow.insertCell(0).textContent = "{{session['area']}}";
                newRow.insertCell(1).textContent = "{{session['data']}}";
                newRow.insertCell(2).textContent = "{{session['ora']}}"
                newRow.insertCell(3).textContent = "{{session['durata']}}"
                newRow.insertCell(4).textContent = "{{session['lon']}}"
                newRow.insertCell(5).textContent = "{{session['lat']}}"
                newRow.insertCell(6).textContent = "{{session['temp']}}"
                newRow.insertCell(7).textContent = "{{session['codice_GISA']}}"
                newRow.insertCell(8).textContent = "{{session['comune']}}"
            }
        }

        function clearTableInfoSim() {
            let body_table = document.getElementById('info-table').getElementsByTagName('tbody')[0];
            if(body_table) {
                table.removeChild(tbody);
            }
        }
        
        function checkProgressWorkflow() {
            if("{{session['workflow_id']}}" != "") {

                let url = '/get-status-workflow/' + "{{session['workflow_id']}}"; 

                fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {

                    console.log("data from Dagon : " , data);

                    let table_body = document.getElementById('state-table').getElementsByTagName('tbody')[0];
                    
                    if(table_body.rows.length > 0) {  
                        let first_row = table_body.rows[0];
                        let workflow = ['calmet', 'calpost', 'calpufff', 'calwrff', 'ctgproc', 'dst', 'lnd2', 'makegeo', 'terrel', 'wrf2calwrf', 'www'];
                        
                        for(let i=1; i<12; i++) {
                            if(!first_row.cells[i]){
                                first_row.insertCell(i).textContent = data[workflow[i-1]];
                            } else {
                                first_row.cells[i].textContent = data[workflow[i-1]];
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('C\'è stato un problema con la tua richiesta:', error);
                });
           }
        }

        output.innerHTML = slider.value;
        slider.oninput = function() {
                output.innerHTML = this.value / 5;
        }
        
        fetch('static/centroidi_comuni/centroidi_comuni.geojson')
        .then(response => response.json())
        .then(data => {
            for (let feature of data.features) {
                comuni.push(feature.properties.COMUNE)
            }
        })
        .catch(error => console.error('Errore durante il recupero del file:', error));
    </script>       
</body>
</html>